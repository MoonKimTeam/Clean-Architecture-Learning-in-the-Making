# 영속성 어댑터 구현하기

## 의존성 역전

헥사고날 아키텍쳐에서 영속성 어댑터는 ‘주도되는’ 혹은 ‘아웃고잉’ 어댑터이다. 애플리케이션에 의해 호출될 뿐 애플리케이션을 호출하지는 않기 때문이다.

## 영속성 어댑터의 책임

### 영속성 어탭터의 역할
01. 입력을 받는다
02. 입력을 데이터베이스 포맷으로 매핑한다
03. 입력을 데이터베이스로 보낸다
04. 데이터베이스 출력을 애플리케이션 포맷으로 매핑한다
05. 출력을 반환한다

영속성 어댑터는 포트 인터페이스를 통해 입력을 받는다. 입력 모델은 특정 데이터베이스 연산 전용 객체로 변환될 수 있다. JPA와 같은 객체-관계 매핑 프레임워크를 사용할 경우, 입력 모델은 JPA 엔터티 객체로 매핑된다. 그러나 다른 기술을 사용하여 SQL 구문에 매핑하거나 데이터를 파일로 직렬화하여 읽어오는 등 다양한 전략이 가능하다.

영속성 어댑터의 입력 모델은 애플리케이션 코어가 아니라 어댑터 내부에 존재해야 하며, 이를 통해 어댑터를 변경하더라도 애플리케이션 코어에 영향을 주지 않는다. 마지막으로, 데이터베이스 응답은 포트에 정의된 출력 모델로 매핑되어 반환된다. 중요한 점은 출력 모델이 영속성 어댑터가 아닌 애플리케이션 코어에 위치해야 한다는 것이다.

## 포트 인터페이스 나누기

특정 엔티티가 필요로 하는 모든 데이터베이스 연산을 하나의 리포지토리 인터페이스에 넣는 일반적인 방식에서는 모든 서비스가 단일 포트 인터페이스에 의존성을 가지게 되어 코드에 불필요한 의존성이 생긴다고 지적한다.

인터페이스 분리 원칙을 적용하여 각 서비스는 실제로 필요로 하는 메서드에만 의존하도록 구성되어, 코드가 더 명확하고 테스트하기 쉬워진다. 이렇게 되면 코드에서 불필요한 의존성을 제거하고, 테스트 시 어떤 메서드를 모킹할지 고민할 필요가 없도록 해준다

## 영속성 어댑터 나누기

JPA나 OR 매퍼를 사용하는 경우 성능을 개선하고자 SQL을 사용하는 별도의 포트를 구현할 수 있으며, JPA 어댑터와 SQL 어댑터를 각각의 영속성 포트 일부로 구현할 수 있다. 도메인 코드는 특정 클래스가 어떤 포트를 충족시키는지에 관계없이 동작하며, 모든 포트가 구현되기만 하면 영속성 계층이 요구하는 작업이 수행될 수 있다.

각 바운디드 컨텍스트는 하나의 영속성 어댑터를 가지며 도메인 경계 내에서의 역할과 책임을 명확히 할 수 있다
