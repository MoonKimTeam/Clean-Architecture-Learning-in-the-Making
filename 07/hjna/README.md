# 아키텍처 요소 테스트 하기

## 테스트 피라미드

테스트 피라미드는 비용과 실행 속도, 안정성을 고려하여 테스트를 구성해야 한다고 강조한다. 단위 테스트는 비용이 적고, 유지보수하기 쉬우며, 빠르고 안정적으로 실행될 수 있는 테스트다. 일반적으로 하나의 클래스나 메서드에 집중하며, 다른 클래스에 의존하는 경우 목(mock)을 활용하여 독립성을 유지한다.

통합 테스트는 연결된 여러 유닛을 인스턴스화하고 상호작용을 검증한다. 시작점 클래스의 인터페이스로 데이터를 전송하며, 유닛 간 네트워크가 기대대로 작동하는지를 확인한다. 두 계층 간의 경계를 테스트하며, 경우에 따라 목을 사용하는 것이 필요할 수 있다.

시스템 테스트는 애플리케이션을 구성하는 모든 객체 네트워크를 가동시켜 특정 유스케이스가 잘 작동하는지를 확인한다.

## 단위 테스트로 도메인 엔티티 테스트하기

단위 테스트로 도메인 엔티티를 테스트하기 위해서는 육각형 아키텍처의 중심인 도메인 엔티티를 살펴보는 것이 중요하다. 

Account 엔티티는 과거 특정 시점의 계좌 잔고와 이후의 입출금 내역으로 구성된다. 단위 테스트는 이 Account 객체의 withdraw() 메서드가 기대한 대로 동작하는지를 검증한다.

단위 테스트에서는 특정 상태에서 Account 객체를 인스턴스화하고 withdraw() 메서드를 호출하여 출금이 성공했는지를 검증한다. 또한 Account 객체의 상태에 기대한 부수효과들이 잘 일어났는지를 확인하는데, 이는 단순하고 명확하게 테스트할 수 있다.

도메인 엔티티의 행동은 다른 클래스에 거의 의존하지 않기 때문에 다른 종류의 테스트는 필요하지 않다.

## 단위 테스트로 유스케이스 테스트하기

단위 테스트로 유스케이스를 테스트하기 위해 SendMoneyService를 예로 든다. 이 유스케이스는 출금 계좌의 잔고가 다른 트랜잭션에 의해 변경되지 않도록 잠금을 건다. 출금 계좌에서 돈이 출금된 후 동일한 금액이 입금 계좌에 추가되며, 두 계좌에서 모두 올바르게 반영되는지를 검증한다.

테스트는 given/when/then 형식으로 구성된다. given 섹션에서는 출금 및 입금 계좌를 생성하고 초기 상태를 설정한다. when 섹션에서는 유스케이스 실행을 위해 sendMoney() 메서드를 호출한다. then 섹션에서는 트랜잭션 성공 여부와 출금 및 입금 결과를 검증한다.

Mockito를 사용하여 목 객체를 생성하고, 특정 메서드 호출 여부를 then() 메서드로 확인한다. 서비스가 상태를 가지지 않기 때문에 목 객체와의 상호작용을 검증하여 테스트가 코드 구조 변경에도 견고하도록 한다.

모든 동작을 검증하기보다는 핵심 동작에 집중해야 한다. 필요 이상으로 의존성을 테스트하면 유지보수가 어렵다. 이 테스트는 단위 테스트에 가깝지만, 의존성의 상호작용을 다루기 때문에 통합 테스트와 단위 테스트의 중간 단계에 해당한다.

## 통합 테스트로 웹 어댑터 테스트하기

통합 테스트로 웹 어댑터를 테스트하기 위해 JSON 입력 데이터를 HTTP 요청으로 전송하여 유효성을 검증한다. 웹 어댑터의 테스트는 입력 데이터가 유스케이스에 전달되고 기대한 결과가 JSON으로 반환되는지를 확인한다.

MockMvc를 사용하여 HTTP 요청 경로, 헤더, 입력 데이터를 정의하고 isOk() 메서드로 응답 상태가 200인지 검증한다. 이 과정에서 SendMoneyCommand 객체가 생성되고 유효한 입력 데이터로 매핑되었는지도 확인한다.

웹 어댑터 테스트는 하나의 컨트롤러 클래스만 테스트하지만, 내부적으로 HTTP 요청 경로와 네트워크 구성 요소들이 올바르게 동작하는지를 검증한다. 이를 통해 프레임워크와 통합된 상태에서 웹 컨트롤러의 동작을 확인한다.

프레임워크에 강하게 의존하는 웹 컨트롤러는 단순한 단위 테스트로는 충분히 검증할 수 없으므로, 통합 테스트를 통해 HTTP 매핑, 유효성 검사, 그리고 프레임워크의 동작을 함께 확인해야 한다.

## 통합 테스트로 영속성 어댑터 테스트하기

영속성 어댑터의 테스트에는 단위 테스트보다 통합 테스트를 적용하는 것이 합리적이다. 어댑터의 로직뿐만 아니라 데이터베이스 매핑도 검증해야 하기 때문이다.

@DataJpaTest 애너테이션은 데이터베이스 접근에 필요한 객체 네트워크를 인스턴스화한다. @Import 애너테이션을 통해 필요한 어댑터 클래스와 매퍼 클래스를 포함한다. 테스트는 데이터베이스와 연동하여 SQL 스크립트를 기반으로 계좌 데이터를 로드하고, 결과를 검증한다.

loadAccount 테스트는 SQL을 통해 데이터베이스에 저장된 계좌 데이터를 로드하여 객체의 상태를 확인한다. updateActivities 테스트는 계좌 활동 데이터를 업데이트하고, 데이터베이스에 잘 저장되었는지를 확인한다.

영속성 어댑터 테스트는 실제 데이터베이스를 사용해야 하며, 이를 위해 Testcontainers와 같은 도구를 사용하는 것이 추천된다. 인메모리 데이터베이스를 사용하는 경우, 실제 환경과 차이가 생겨 데이터베이스 마이그레이션 검증 등에 문제가 생길 가능성이 높다.

## 시스템 테스트로 주요 경로 테스트하기

시스템 테스트는 애플리케이션 전체를 실행하고 API를 통해 주요 경로를 검증한다. @SpringBootTest 애너테이션은 애플리케이션과 객체 네트워크를 모두 초기화한다. TestRestTemplate을 사용해 실제 HTTP 요청을 보내고 응답 상태와 데이터를 검증한다.

테스트는 주요 유스케이스를 시나리오 형태로 실행하며, 초기 상태와 결과 상태를 비교한다. 예를 들어, 계좌 간 송금에서 잔고가 올바르게 갱신되었는지를 확인한다. 테스트는 단위 테스트와 통합 테스트에서 발견하지 못한 버그를 찾을 수 있다.

시스템 테스트는 단위 테스트와 통합 테스트로 검증하지 못한 시나리오를 다룬다. 이를 통해 애플리케이션이 최신 변경사항을 정상적으로 반영하며 배포 준비가 되었는지를 확인한다.


* 핵심 도메인 로직은 단위 테스트로, 어댑터는 통합 테스트로 처리하는 명확한 테스트 전략을 세울 수 있다. 모킹하는 것이 너무 버거워지거나 코드의 특정 부분을 커버하기 위해 어떤 종류의 테스트를 써야 할지 모르겠다면 이는 경고 신호다.