# 의존성 역전하기

## 단일 책임 원칙

단일 책임 원칙의 정의는 아래와 같다.

하나의 컴포넌트는 오로지 한 가지 일만 해야 하고, 그것을 을바르게 수행해야 한다.

단일 책임 원칙의 실제 정의는 다음과 같다.

컴포넌트를 변경하는 이유는 오직 하나뿐이어야 한다.

‘책임’은 사실 ‘오로지 한 가지 일만 하는 것’보다는 ‘변경할 이유’로 해석해야 한다.

만약 컴포넌트를 변경할 이유가 오로지 한 가지라면 컴포넌트는 딱 한 가지 일만 하게 된다.

의존하지 않는 컴포넌트를 변경할 유일한 이유는 새로운 요구사항에 의해 컴포넌트의 기능을 바꿔야 할 때뿐이다.

반면 타 컴포넌트에 의존하는 컴포넌트는 다른 컴포넌트에 의존하고 있기 때문에 다른 어떤 컴포넌트가 바뀌든지 같이 바뀌어야 한다.

## 부수효과에 관한 이야기

코드를 유지보수하는 인원이 바뀌면 코드가 실제로 어떤 일을 하는지를 이해하기가 쉽지 않았고, 코드의 한 영역을 변경했더니 다른 영역에서 부수효과가 생겨나기 쉽다.

또한, 이런 부수효과는 클라이언트의 과거에 겪었던 경험 때문에 부수효과를 피하려고 비효율적인 방식을 고집하게 만들 수 있다.

## 의존성 역전 원칙

계층형 아키텍처에서 계층 간 의존성은 항상 다음 계층인 아래 방향을 가리킨다. 이를 통해 단일책임원칙을 고수준에서 적용할 때 상위 계층들이 하위 계층들에 비해 변경할 이유가 더 많다는 것을 알 수 있다.

영속성 계층에 대한 도메인 계층의 의존성 때문에 영속성 계층을 변경할 때마다 잠재적으로 도메인 계층도 변경해야 한다.

의존성 역전의 원칙은 다음과 같다.

코드상의 어떤 의존성이든 그 방향을 바꿀 수(역전시킬 수) 있다

도메인 계층에 인터페아스를 도입함으로써 의존성을 역전시킬 수 있고, 그 덕분에 영속성 계층이 도메인 계층에 의존하게 된다.

## 클린 아키텍쳐

클린 아키텍처에서는 설계가 비즈니스 규칙의 테스트를 용이하게 하며, 비즈니스 규칙이 프레임워크, 데이터베이스, UI 기술, 외부 애플리케이션이나 인터페이스로부터 독립적일 수 있다고 말한다. 이는 도메인 코드가 바깥으로 향하는 어떤 의존성도 없어야 함을 의미한다.

클린 아키텍처에서 모든 의존성은 도메인 로직을 향해 안쪽 방향으로 향한다.

이 아키텍처에서 가장 주요한 규칙은 의존성 규칙으로 계층 간의 모든 의존성이 안쪽으로 향해야 한다는 것이다.

이 아키텍쳐에서 서비스는 단일 책임（변경할 단 한 가지의 이유）을 갖기 위해 조금 더 세분화돼 있다. 이를 통해 이전에 이야기했던 넓은 서비스 문제를 피할 수 있다.

일반적으로 ORM 프레임워크는 데이터베이스 구조 및 객체 필 드와 데이터베이스 칼럼의 매핑을 서술한 메타데이터를 담고 있는 엔티티 클래스를 필요 로 한다. 도메인 계층은 영속성 계층을 모르기 때문에 도메인 계층에서 사용한 엔티티 클 래스를 영속성 계층에서 함께 사용할 수 없고 두 계층에서 각각 엔티티를 만들어야 한다. 즉, 도메인 계층과 영속성 계층이 데이터를 주고받을 때, 두 엔티티를 서로 변환해야 한 다는 뜻이다. 이는 도메인 계층과 다른 계층들 사이에서도 마찬가지다.

ORM 프레임워크는 엔티티 클래스를 인스턴스화할 때 리플렉션을 사용하므로, 인자가 없는 기본 생성자(no-args constructor)를 요구한다. 이는 JPA가 객체를 생성하고 데이터베이스와 매핑하는 작업을 수행하기 위해 필요한 제약이다. 그러나 도메인 모델의 순수성 관점에서 볼 때, 이러한 제약은 도메인 모델이 프레임워크에 종속되는 결합을 초래한다.

기본 생성자는 객체를 불완전한 상태로 만들 가능성을 내포하고 있다. 따라서 도메인 모델이 비즈니스 규칙을 표현하는 데 집중하기보다는 프레임워크의 제약에 맞추어야 하는 상황이 발생하게 된다. 이는 도메인 코드가 프레임워크로부터 독립적이어야 한다는 원칙을 위배하는 사례라 할 수 있다.

## 육각형 아키텍처（헥사고날 아키텍처）

육각형 아키텍쳐인 이유는 애플리케이션이 다른 시스템이나 어댑터와 연결되는 4개 이상의 면을 가질 수 있음을 보여주기 위해 일반적인 사각형 대신 육각형을 사용했다고 한다.

육각형 아키텍처의 중심에는 도메인 엔티티와 외부와 상호작용하는 유스케이스가 위치한다. 이러한 유스케이스는 외부 의존성 없이 독립적으로 동작하며, 모든 의존성은 애플리케이션 내부가 아닌 외부를 향한다. 애플리케이션의 핵심 로직은 외부 시스템과의 결합을 최소화하고, 필요한 상호작용은 어댑터를 통해 이루어진다.

육각형 아키텍처의 외곽에는 다양한 어댑터들이 위치한다. 이 어댑터들은 애플리케이션과 웹 브라우저, 외부 시스템, 데이터베이스 등과 상호작용한다. 왼쪽의 어댑터들은 애플리케이션을 주도하는 어댑터들로서, 애플리케이션 코어를 호출하는 방식으로 동작하며, 오른쪽 어댑터들은 애플리케이션 코어에 의해 호출되는 어댑터들로 구성된다.

애플리케이션 코어와 어댑터들 간의 통신을 위해서는 각 포트가 인터페이스를 제공해야 한다. 주도하는 어댑터(Driving Adapter)는 이 포트를 통해 유스케이스를 호출하고, 주도되는 어댑터(Driven Adapter)는 이러한 포트를 통해 애플리케이션 코어에 의해 호출된다.

이 아키텍처는 ‘포트와 어댑터(ports-and-adapters)’ 아키텍처로도 불리며, 계층으로 구성된다. 가장 외곽의 계층에는 애플리케이션과 외부 시스템 간의 번역을 담당하는 어댑터들이 위치하고, 그 다음 계층에는 포트와 유스케이스 구현체가 위치한다.

## 유지보수 가능한 소프트웨어를 만드는 데 어떻게 도움이 될까?

의존성을 역전시켜 도메인 코드가 외부 코드에 의존하지 않도록 함으로써 영속성 및 UI 관련 문제로부터 도메인 로직의 결합을 제거하고, 변경할 이유를 줄여 유지보수성을 높일 수 있다.

도메인 코드는 비즈니스 문제에 딱 맞도록 자유롭게 모델링될 수 있고 영속성 코드와 UI 코드도 영속성 문제와 UI 문제에 맞게 자유롭게 모델링될 수 있다.


